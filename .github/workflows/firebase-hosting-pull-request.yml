# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on:
  pull_request:
    branches:
      - "**"
      - "!renovate/**"
jobs:
  hosting_preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: ".node-version"
          cache: "pnpm"

      - run: pnpm i
      - run: HASH="$GITHUB_SHA" pnpm run web:build
      - uses: FirebaseExtended/action-hosting-deploy@e2eda2e106cfa35cdbcf4ac9ddaf6c4756df2c8c # v0.10.0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_CICUMIKUJI }}"
          projectId: cicumikuji
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels

  functions_preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version-file: ".node-version"
          cache: "pnpm"
      - run: pnpm i
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@f6de81663f7788d05bd15bcce18f0e57f23f0846 # v2.0.1
        with:
          credentials_json: "${{ secrets.FIREBASE_FUNCTION_SERVICE_ACCOUNT }}"
      - name: Install firebase tools
        run: npm install -g firebase-tools
      - name: Deploy Functions (dry-run)
        run: firebase deploy --only functions --dry-run
